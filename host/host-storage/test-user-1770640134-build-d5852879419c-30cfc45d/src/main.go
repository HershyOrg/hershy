package main\n\nimport (\n\t\"context\"\n\t\"fmt\"\n\t\"io\"\n\t\"log\"\n\t\"os\"\n\t\"path/filepath\"\n\t\"time\"\n\n\t\"github.com/HershyOrg/hersh\"\n)\n\nfunc main() {\n\t// Setup logging to /state directory\n\tstateDir := \"/state\"\n\tos.MkdirAll(stateDir, 0755)\n\tlogFile, err := os.Create(filepath.Join(stateDir, \"counter.log\"))\n\tif err != nil {\n\t\tfmt.Printf(\"\u26a0\ufe0f  Failed to create log file: %v\\n\", err)\n\t\tlogFile = nil\n\t}\n\tif logFile != nil {\n\t\tdefer logFile.Close()\n\t\tlog.SetOutput(io.MultiWriter(os.Stdout, logFile))\n\t} else {\n\t\tlog.SetOutput(os.Stdout)\n\t}\n\n\tlog.Println(\"\ud83d\ude80 Starting Simple Counter Demo\")\n\n\t// Create config with WatcherAPI enabled\n\tconfig := hersh.DefaultWatcherConfig()\n\tconfig.ServerPort = 8080 // Enable WatcherAPI on port 8080\n\tconfig.DefaultTimeout = 5 * time.Minute\n\n\tenvVars := map[string]string{\n\t\t\"DEMO_NAME\":    \"Simple Counter\",\n\t\t\"DEMO_VERSION\": \"1.0.0\",\n\t}\n\n\t// Create context\n\tctx := context.Background()\n\n\t// Create Watcher\n\twatcher := hersh.NewWatcher(config, envVars, ctx)\n\n\t// Register managed function\n\twatcher.Manage(func(msg *hersh.Message, ctx hersh.HershContext) error {\n\t\tif msg.Content == \"tick\" {\n\t\t\t// Get counter from context value store\n\t\t\tcounterVal := ctx.GetValue(\"COUNTER\")\n\t\t\tcounter := 0\n\t\t\tif counterVal != nil {\n\t\t\t\tcounter = counterVal.(int)\n\t\t\t}\n\t\t\tcounter++\n\t\t\tctx.SetValue(\"COUNTER\", counter)\n\n\t\t\t// Log the counter value\n\t\t\tlogMsg := fmt.Sprintf(\"[%s] Counter: %d\", time.Now().Format(\"15:04:05\"), counter)\n\t\t\tlog.Println(logMsg)\n\t\t}\n\t\treturn nil\n\t}, \"Counter\").Cleanup(func(ctx hersh.HershContext) {\n\t\tlog.Println(\"\ud83e\uddf9 Cleanup called\")\n\t})\n\n\t// Start Watcher (automatically starts API server on port 8080)\n\tlog.Println(\"\u25b6\ufe0f  Starting Watcher with API server on :8080\")\n\tif err := watcher.Start(); err != nil {\n\t\tlog.Printf(\"\u274c Failed to start: %v\\n\", err)\n\t\tos.Exit(1)\n\t}\n\tlog.Println(\"\u2705 Watcher and WatcherAPI started successfully\")\n\n\t// Send tick messages every second\n\tticker := time.NewTicker(1 * time.Second)\n\tdefer ticker.Stop()\n\n\tgo func() {\n\t\tfor range ticker.C {\n\t\t\twatcher.SendMessage(\"tick\")\n\t\t}\n\t}()\n\n\t// Run indefinitely\n\tlog.Println(\"\ud83d\udd04 Running indefinitely (Ctrl+C to stop)...\")\n\n\t// Block forever\n\tselect {}\n}\n